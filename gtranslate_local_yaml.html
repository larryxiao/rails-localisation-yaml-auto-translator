<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://www.prototypejs.org/assets/2008/9/29/prototype-1.6.0.3.js"></script>
    <script type="text/javascript">

    google.load("language", "1");

/*
    function initialize() {
      var text = document.getElementById("text").innerHTML;
      google.language.detect(text, function(result) {
        if (!result.error && result.language) {
          google.language.translate(text, result.language, "en",
                                    function(result) {
            var translated = document.getElementById("translation");
            if (result.translation) {
              translated.innerHTML = result.translation;
            }
          });
        }
      });
    }
    google.setOnLoadCallback(initialize);
*/

    /**
     * source content object, living in global space so it can be accessed by callbacks
     */
    var sourceLines; // type: Array

    /**
     * a explict point for going through yaml
     */
    var currentLineNumber;

    /**
     * the text field for result output
     */
    var resultField;

    /**
     * mark the system is ready
     */
    google.setOnLoadCallback(
        function(){
            document.getElementById("status_node").innerHTML = "Ready".bold();
            resultField = document.getElementById("result_field");
        }
    );


    function doTranslate()
    {
        // get the source content
        var source_content = $("source_content").value.strip();

        if(source_content == "")
        {
            reportFailure("missing source content");
            return;
        }

        sourceLines = source_content.split('\n');
        currentLineNumber= 0;

        translateLine();

        return false;
    }

    /**
     * translate the yaml line by line
     */
    function translateLine()
    {
        // reach end?
        if(currentLineNumber >= sourceLines.length)
        {
            alert("job done!");
            return
        }

        // get the current line content
        var currentLine = sourceLines[currentLineNumber++];

        // is this a valid key:value line
        if(currentLine.indexOf(':') == -1)
        {
            addTranslatedResult(currentLine);
            translateLine();
        }

        // is this a valid key:value line, again
        var strippedLine = currentLine.strip();
        if(strippedLine.lastIndexOf(':') == strippedLine.length -1)
        {
            addTranslatedResult(currentLine);
            translateLine();
        }

        // translate this line
        currentLine.sub(/\s+(.*?)\:\s+\"(.*?)\"/,  function(match)
            {
                // get leading spaces
                var firstHalf = match[0].split(':')[0];
                var leadingSpaces = ' '.times(firstHalf.lastIndexOf(' ') + 1);
                addTranslatedResult(leadingSpaces+match[1]+':"');
                gTranslate(match[2]);
                return '';
                // return '<img alt="' + match[1] + '" src="' + match[2] + '" />';
            }
        )
    }

    /**
     * add translated line into the result field
     *
     * @param content [String]
     */
    function addTranslatedResult(content)
    {
        resultField.value += "\n"+ content;
    }

    function padTranslatedResult(content)
    {
        resultField.value += content + '"';
        translateLine();
    }


    /**
     * report failure message into the output field
     *
     * @param msg[String] failure message
     */
    function reportFailure(msg)
    {
        resultField.value = "ERROR!!!\n"+msg;
    }

    /**
     * wrap the google translator
     */
    function gTranslate(text)
    {
        google.language.translate(text, "en", "zh-CN",  function(result)
        {
            var translated = document.getElementById("translation");
            if (result.translation) {
                padTranslatedResult(result.translation);
            }
            else
            {
                padTranslatedResult("ERROR! fail to translate this entry.");
            }
        });
    }

    /**
     * A poorly written yaml parser :)
     * It convert yaml to json first, and then parse the json string into a data object.
     * 
     * @param yaml (String) the yaml data string
     * 
     * @return (Object) 
     */
    function yaml2Objct(yaml)
    {
		// compact the string
		// source_content = source_content.gsub(/\"\n\s+/,'"; ');
		yaml = yaml.gsub(/\s+(.*?)\:\s+\"(.*?)\"\n/,'"#{1}":"#{2}", ');
        yaml = yaml.gsub(/\,\s+\n\s+/,'},\n  ');
        yaml = yaml.gsub(/\}\,\n\s+(.*?)\:/,'},\n  "#{1}":{');
        yaml = yaml.gsub(/\:\n\s+(.*?)\:/,':\n  "#{1}":{');
        yaml = yaml.gsub(/\:\n\s+/,':{\n  ');
        yaml = "{"+yaml+"}}}";

        // a bit pretty format without indention
        yaml = yaml.gsub('", "','", \n"').gsub('"},','"\n},').gsub('":{"','":{\n"');

        return yaml.evalJSON();
    }

/*
	function tempSet()
	{
		result_node.value = source_content;
	}

	function tempReset()
	{
		source_content = $("source_content").value.strip();
	}
*/

    </script>
  </head>
  <body>
      <!--
    <div id="text">你好，很高興見到你。</div>
    -->
    <div>
        Status:
        <span id="status_node">Waiting for Google translate API...</span>
    </div>

    <hr>

    <form action="js_translate">
        Source YAML content:
        <br>
        <textarea id="source_content" name="source_content" rows="20" cols="100" nowrap=nowrap >


en:
  global:
    click_here:   "Click here"
    submit:       "Submit"
    cancel:       "Cancel"
    preview:      "Preview"
    create:       "Create"
    edit:         "Edit"
    update:       "Update"
    upload:       "Upload"
    save:         "Save"
    delete:       "Delete"
    destroy:      "Destroy"
    are_you_sure: "Are you sure?"
    see_all:      "See All"
    show:         "Show"
    back:         "Back"
    the_site:     "the site"
    ago:          "{{time_ago}} ago"
    demo_site:    "This is a demonstration site.<br/>Data may be modified or removed without warning."
    automated_message: "Note: this is an automated message; please do not reply, as there's no human at the other end of it."
    thanks:       "Thanks!"
    or:           " or "
    warning:      "Warning"

  activity:
    delete_activity_confirmation: "Are you sure you want to delete this  activity from your profile?"
    delete_activity: "Delete this activity"
    just_joined:  "joined the system"
    person_joined: "{{person}} has joined the system"
    invalid_activity_type: "Invalid activity type {{activity}}"

        </textarea>
        <br>
        <input type="button" id="translate_btn" value="Translate" onclick="doTranslate()"/>

		<hr>
		<textarea id="result_field" name="source_content" rows="20" cols="100" nowrap=nowrap >
		</textarea> 
	</form>
<div id="translation"></div>
  </body>
</html>
